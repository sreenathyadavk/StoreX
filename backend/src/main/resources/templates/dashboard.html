<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Dashboard - Cloud File Storage</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>

<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <div class="container dashboard-container">
        <div class="header">
            <h1>My Files</h1>
        </div>

        <div class="upload-section">
            <h3>Upload New File</h3>
            <form th:action="@{/upload}" method="post" enctype="multipart/form-data" style="align-items: center;">
                <input type="file" name="file" required>
                <button type="submit" style="margin-top: 1rem;">Upload File</button>
            </form>
        </div>

        <h3>Recent Files</h3>
        <table>
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Upload Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="file : ${files}">
                    <td th:text="${file.filename}" style="font-weight: 500;">filename.txt</td>
                    <td th:text="${file.displaySize}">1.2 MB</td>
                    <td th:text="${#dates.format(file.uploadDate, 'MMM dd, yyyy HH:mm')}">Jan 01, 2023 12:00</td>
                    <td class="actions">
                        <a href="#" th:data-id="${file.id}" th:data-type="${file.contentType}"
                            th:data-filename="${file.filename}" onclick="openPreview(this)">Preview</a>
                        <a th:href="@{/download/{id}(id=${file.id})}">Download</a>
                        <a th:href="@{/delete/{id}(id=${file.id})}" class="delete"
                            onclick="return confirm('Are you sure you want to delete this file?')">Delete</a>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(files)}">
                    <td colspan="4" style="text-align: center; color: var(--text-muted); padding: 2rem;">No files
                        uploaded yet. Start by uploading a file above.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePreview()">&times;</span>
            <h3 id="previewTitle">File Preview</h3>
            <div class="preview-content" id="previewContainer">
                <!-- Content will be injected here -->
            </div>
        </div>

        <script>
            function openPreview(element) {
                const id = element.getAttribute('data-id');
                const contentType = element.getAttribute('data-type');
                const filename = element.getAttribute('data-filename');

                const modal = document.getElementById('previewModal');
                const container = document.getElementById('previewContainer');
                const title = document.getElementById('previewTitle');

                title.textContent = filename;
                container.innerHTML = '';

                if (contentType.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = `/view/${id}`;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '70vh';
                    img.style.borderRadius = 'var(--radius)';
                    container.appendChild(img);
                } else if (contentType.startsWith('video/')) {
                    const videoWrapper = document.createElement('div');
                    videoWrapper.style.width = '100%';
                    videoWrapper.style.maxWidth = '800px';
                    videoWrapper.style.margin = '0 auto';

                    const video = document.createElement('video');
                    video.src = `/view/${id}`;
                    video.controls = true;
                    video.style.width = '100%';
                    video.style.borderRadius = 'var(--radius)';
                    video.style.boxShadow = 'var(--shadow-md)';

                    videoWrapper.appendChild(video);
                    container.appendChild(videoWrapper);
                } else {
                    container.innerHTML = '<p>Preview not available for this file type.</p>';
                }

                modal.style.display = 'block';
            }

            function closePreview() {
                const modal = document.getElementById('previewModal');
                const container = document.getElementById('previewContainer');
                modal.style.display = 'none';
                container.innerHTML = ''; // Stop video playback
            }

            window.onclick = function (event) {
                const modal = document.getElementById('previewModal');
                if (event.target == modal) {
                    closePreview();
                }
            }
        </script>
</body>

</html>